<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>LeviSpeed GPS</title>
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#070010"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Exo+2:wght@300;700;900&display=swap" rel="stylesheet"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    :root{
      --v:#7c3aed;--vl:#c084fc;
      --f:#ea580c;--fl:#fb923c;--gold:#fbbf24;--g:#4ade80;
    }
    html,body{width:100%;height:100%;overflow:hidden;}
    body{
      font-family:'Share Tech Mono',monospace;
      background:#070010;color:#fff;user-select:none;
      display:flex;flex-direction:column;
      width:100vw;
      height:100vh;height:100dvh;
      overflow:hidden;position:fixed;
      top:0;left:0;right:0;bottom:0;
    }
    body::before{
      content:'';position:fixed;inset:0;
      background-image:
        linear-gradient(rgba(124,58,237,0.05) 1px,transparent 1px),
        linear-gradient(90deg,rgba(234,88,12,0.05) 1px,transparent 1px);
      background-size:28px 28px;pointer-events:none;z-index:0;
    }
    body::after{
      content:'';position:fixed;inset:0;
      background:
        radial-gradient(ellipse at 15% 10%,rgba(124,58,237,0.2) 0%,transparent 45%),
        radial-gradient(ellipse at 85% 90%,rgba(234,88,12,0.15) 0%,transparent 45%);
      pointer-events:none;z-index:0;
    }
    /* ── COMBO A: Radar central + pulsos radiales ── */
    .radar-wrap{position:fixed;inset:0;z-index:50;pointer-events:none;}

    /* Radar girando */
    .radar-ring{
      position:absolute;
      width:220px;height:220px;
      top:50%;left:50%;
      transform:translate(-50%,-50%);
      border-radius:50%;
      border:1px solid rgba(74,222,128,0.08);
    }
    .radar-ring::before{
      content:'';position:absolute;
      top:50%;left:50%;width:50%;height:1.5px;
      transform-origin:left center;
      background:linear-gradient(90deg,rgba(74,222,128,0.85),transparent);
      box-shadow:0 0 8px rgba(74,222,128,0.7);
      animation:radarSpin 5s linear infinite;
    }
    .radar-ring::after{
      content:'';position:absolute;inset:0;border-radius:50%;
      background:conic-gradient(from 0deg,rgba(74,222,128,0.07),transparent 50%);
      animation:radarSpin 5s linear infinite;
    }
    @keyframes radarSpin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    /* Pulsos radiales */
    .rpulse{
      position:absolute;border-radius:50%;
      top:50%;left:50%;
      transform:translate(-50%,-50%);
      animation:rPulseOut 3.5s ease-out infinite;
    }
    .rpulse:nth-child(2){border:1.5px solid rgba(192,132,252,0.55);animation-delay:0s;}
    .rpulse:nth-child(3){border:1px solid rgba(251,146,60,0.35);animation-delay:1.2s;}
    .rpulse:nth-child(4){border:1.5px solid rgba(192,132,252,0.35);animation-delay:2.4s;}
    @keyframes rPulseOut{
      0%{width:0;height:0;opacity:0.9;}
      100%{width:400px;height:400px;opacity:0;}
    }

    /* Puntos del radar */
    .rdot{
      position:absolute;border-radius:50%;z-index:51;
      animation:rdotBlink 5s linear infinite;
    }
    .rdot:nth-child(5){width:5px;height:5px;top:32%;left:63%;background:var(--g);box-shadow:0 0 8px var(--g);animation-delay:1.0s;}
    .rdot:nth-child(6){width:4px;height:4px;top:64%;left:36%;background:var(--fl);box-shadow:0 0 6px var(--fl);animation-delay:2.8s;}
    .rdot:nth-child(7){width:5px;height:5px;top:42%;left:74%;background:var(--g);box-shadow:0 0 8px var(--g);animation-delay:4.2s;}
    @keyframes rdotBlink{0%,88%,100%{opacity:0;}90%{opacity:1;}95%{opacity:0.5;}97%{opacity:0;}}
    #particles{position:fixed;inset:0;z-index:1;pointer-events:none;}
    .c-tr{position:fixed;top:0;right:0;width:44px;height:44px;z-index:15;pointer-events:none;
      background:linear-gradient(225deg,var(--v) 45%,transparent 45%);}
    .c-bl{position:fixed;bottom:0;left:0;width:28px;height:28px;z-index:15;pointer-events:none;
      background:linear-gradient(45deg,var(--f) 45%,transparent 45%);}
    .flames{position:fixed;bottom:0;left:0;right:0;height:60px;pointer-events:none;z-index:2;overflow:hidden;}
    .flame{position:absolute;bottom:0;border-radius:50% 50% 20% 20%;animation:flameUp linear infinite;}
    .flame:nth-child(1){left:3%;width:3px;background:rgba(168,85,247,0.6);animation-duration:2.0s;animation-delay:0.0s;}
    .flame:nth-child(2){left:13%;width:5px;background:rgba(249,115,22,0.7);animation-duration:1.7s;animation-delay:0.4s;}
    .flame:nth-child(3){left:23%;width:3px;background:rgba(251,191,36,0.5);animation-duration:2.3s;animation-delay:0.8s;}
    .flame:nth-child(4){left:35%;width:6px;background:rgba(168,85,247,0.5);animation-duration:1.5s;animation-delay:0.2s;}
    .flame:nth-child(5){left:47%;width:4px;background:rgba(249,115,22,0.8);animation-duration:2.1s;animation-delay:0.6s;}
    .flame:nth-child(6){left:58%;width:5px;background:rgba(168,85,247,0.6);animation-duration:1.9s;animation-delay:1.0s;}
    .flame:nth-child(7){left:69%;width:3px;background:rgba(251,191,36,0.6);animation-duration:2.2s;animation-delay:0.3s;}
    .flame:nth-child(8){left:80%;width:6px;background:rgba(249,115,22,0.7);animation-duration:1.6s;animation-delay:0.7s;}
    .flame:nth-child(9){left:91%;width:3px;background:rgba(168,85,247,0.5);animation-duration:2.4s;animation-delay:0.1s;}
    @keyframes flameUp{0%{height:0;opacity:0;}15%{opacity:1;}75%{opacity:0.5;}100%{height:55px;opacity:0;transform:scaleX(0.2);}}

    /* ── APP — altura forzada por JS para Android ── */
    .app{position:relative;z-index:10;width:100%;height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}

    /* ── HEADER ── */
    .hdr{
      flex:0 0 auto;padding:7px 14px 5px;
      display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid rgba(124,58,237,0.35);
      background:linear-gradient(90deg,rgba(124,58,237,0.1),rgba(234,88,12,0.07));
    }
    .logo{font-family:'Orbitron',sans-serif;font-size:clamp(13px,3.5vw,18px);font-weight:900;letter-spacing:3px;
      background:linear-gradient(135deg,var(--vl),var(--fl));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .hdr-right{display:flex;flex-direction:column;align-items:flex-end;gap:2px;}
    .status{font-size:clamp(8px,2vw,10px);letter-spacing:3px;display:flex;align-items:center;gap:5px;color:rgba(255,255,255,0.3);}
    .sdot{width:7px;height:7px;border-radius:50%;background:#333;transition:all 0.3s;}
    .status.active{color:var(--g);}
    .status.active .sdot{background:var(--g);box-shadow:0 0 10px var(--g);animation:sdAnim 2s infinite;}
    .status.error{color:#ef4444;}
    .status.error .sdot{background:#ef4444;box-shadow:0 0 10px #ef4444;}
    @keyframes sdAnim{0%,100%{transform:scale(1);}50%{transform:scale(1.6);opacity:0.4;}}
    .rec-badge{font-size:clamp(8px,2vw,10px);letter-spacing:2px;padding:2px 7px;
      border:1px solid rgba(251,146,60,0.6);color:var(--fl);
      box-shadow:0 0 8px rgba(251,146,60,0.3);animation:recAnim 1.6s ease-in-out infinite;display:none;}
    .rec-badge.on{display:block;}
    @keyframes recAnim{0%,100%{opacity:1;}50%{opacity:0.3;box-shadow:0 0 18px rgba(251,146,60,0.9);}}

    /* ══════════════════════════════════════
       SPEED HERO — grid 2 cols, llena todo
    ══════════════════════════════════════ */
    .speed-hero{
      flex:1 1 0;min-height:0;
      display:grid;
      grid-template-columns:52% 48%;
      grid-template-rows:1fr 1fr;
      overflow:hidden;
    }

    /* ── Celda izquierda: velocidad (span 2 rows) ── */
    .spd-cell{
      grid-column:1;grid-row:1/3;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      border-right:1px solid rgba(255,255,255,0.06);
      padding:0 6px 0 8px;
      position:relative;overflow:hidden;
    }
    .spd-left{position:relative;display:flex;flex-direction:column;align-items:center;width:100%;}
    .streaks{position:absolute;right:calc(100% + 2px);top:0;bottom:0;
      display:flex;flex-direction:column;justify-content:center;gap:6px;pointer-events:none;}
    .streak{height:2px;border-radius:1px;transform-origin:right center;animation:stk 2s ease-in-out infinite;}
    .streak:nth-child(1){width:38px;background:linear-gradient(90deg,transparent,var(--vl));animation-delay:0.0s;}
    .streak:nth-child(2){width:22px;background:linear-gradient(90deg,transparent,var(--fl));animation-delay:0.35s;}
    .streak:nth-child(3){width:48px;background:linear-gradient(90deg,transparent,var(--vl));animation-delay:0.7s;}
    .streak:nth-child(4){width:16px;background:linear-gradient(90deg,transparent,var(--fl));animation-delay:0.2s;}
    .streak:nth-child(5){width:30px;background:linear-gradient(90deg,transparent,var(--vl));animation-delay:0.9s;}
    @keyframes stk{0%,100%{transform:scaleX(0.1);opacity:0;}45%,55%{transform:scaleX(1);opacity:1;}}

    /* Número velocidad — escala con la celda */
    .spd-num{
      font-family:'Exo 2',sans-serif;
      font-size:clamp(88px,26vw,40dvh);
      font-weight:900;line-height:0.82;letter-spacing:-5px;
      color:#fff;position:relative;
      text-shadow:0 0 30px rgba(192,132,252,1),0 0 70px rgba(124,58,237,0.6),4px 4px 0 rgba(251,146,60,0.2);
      animation:nFuse 3s ease-in-out infinite;
      transition:text-shadow 0.4s;
    }
    .spd-num.warn60{
      text-shadow:0 0 30px rgba(251,146,60,1),0 0 70px rgba(234,88,12,0.8),0 0 120px rgba(234,88,12,0.4);
      animation:nOrange 2s ease-in-out infinite;
    }
    @keyframes nOrange{0%,100%{text-shadow:0 0 30px rgba(251,146,60,1),0 0 70px rgba(234,88,12,0.8);}50%{text-shadow:0 0 50px rgba(251,191,36,1),0 0 100px rgba(251,146,60,0.9);}}
    .spd-num.warn80{
      text-shadow:0 0 40px rgba(239,68,68,1),0 0 80px rgba(220,38,38,0.8),0 0 120px rgba(239,68,68,0.5);
      animation:nRed 0.8s ease-in-out infinite;
    }
    @keyframes nRed{0%,100%{text-shadow:0 0 40px rgba(239,68,68,1),0 0 80px rgba(220,38,38,0.8);}50%{text-shadow:0 0 60px rgba(239,68,68,1),0 0 120px rgba(220,38,38,1),0 0 180px rgba(239,68,68,0.6);}}
    .spd-cell.bg80{background:rgba(220,38,38,0.08);}
    .spd-num.fast{animation:nFuse 3s ease-in-out infinite,shake 0.1s linear infinite;}
    .spd-num.warn60.fast{animation:nOrange 2s ease-in-out infinite,shake 0.1s linear infinite;}
    .spd-num.warn80.fast{animation:nRed 0.8s ease-in-out infinite,shake 0.1s linear infinite;}
    @keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-3px);}75%{transform:translateX(3px);}}
    @keyframes nFuse{0%,100%{text-shadow:0 0 30px rgba(192,132,252,1),0 0 70px rgba(124,58,237,0.6),4px 4px 0 rgba(251,146,60,0.2);}50%{text-shadow:0 0 50px rgba(251,146,60,1),0 0 100px rgba(234,88,12,0.7),-4px -4px 0 rgba(192,132,252,0.3);}}
    .spd-num::before{content:attr(data-v);position:absolute;inset:0;color:var(--vl);opacity:0.15;clip-path:polygon(0 18%,100% 18%,100% 32%,0 32%);animation:glA 5s infinite;}
    .spd-num::after{content:attr(data-v);position:absolute;inset:0;color:var(--fl);opacity:0.15;clip-path:polygon(0 65%,100% 65%,100% 78%,0 78%);animation:glB 5s infinite;}
    @keyframes glA{0%,85%,100%{transform:translateX(3px);opacity:0.15;}87%{transform:translateX(-9px);opacity:0.6;}89%{transform:translateX(6px);opacity:0.1;}91%{opacity:0.5;}}
    @keyframes glB{0%,81%,100%{transform:translateX(-3px);opacity:0.15;}83%{transform:translateX(9px);opacity:0.6;}85%{transform:translateX(-6px);opacity:0.1;}87%{opacity:0.5;}}
    .spd-unit{font-size:clamp(10px,2.8vw,13px);letter-spacing:5px;margin-top:5px;
      background:linear-gradient(90deg,var(--vl),var(--fl));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .speed-alert-bar{display:none;position:absolute;bottom:0;left:0;right:0;
      padding:3px 0;text-align:center;font-family:'Orbitron',sans-serif;
      font-size:clamp(8px,2.2vw,10px);letter-spacing:3px;animation:aPulse 0.7s ease-in-out infinite;}
    .speed-alert-bar.warn60{display:block;background:rgba(234,88,12,0.2);color:var(--fl);border-top:1px solid rgba(251,146,60,0.5);}
    .speed-alert-bar.warn80{display:block;background:rgba(220,38,38,0.25);color:#ef4444;border-top:1px solid rgba(239,68,68,0.6);}
    @keyframes aPulse{0%,100%{opacity:1;}50%{opacity:0.3;}}

    /* ── HORA (arriba derecha) ── */
    .time-cell{
      grid-column:2;grid-row:1;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      border-bottom:1px solid rgba(255,255,255,0.05);
      padding:6px 6px 6px 4px;gap:0;
    }
    .clock-val{
      font-family:'Orbitron',sans-serif;
      font-size:clamp(28px,9vw,12dvh);
      font-weight:900;letter-spacing:2px;line-height:1;
      color:#fff;text-shadow:0 0 20px rgba(192,132,252,0.8),0 0 40px rgba(124,58,237,0.4);
      animation:clockGlow 4s ease-in-out infinite;
    }
    @keyframes clockGlow{0%,100%{text-shadow:0 0 20px rgba(192,132,252,0.8),0 0 40px rgba(124,58,237,0.4);}50%{text-shadow:0 0 35px rgba(251,146,60,0.9),0 0 60px rgba(234,88,12,0.5);}}
    .clock-secs{font-family:'Share Tech Mono',monospace;font-size:clamp(13px,3.5vw,5dvh);letter-spacing:3px;color:rgba(255,255,255,0.3);margin-top:2px;}
    .clock-label{font-size:clamp(7px,1.8vw,9px);letter-spacing:4px;color:rgba(255,255,255,0.18);margin-top:3px;}

    /* ── GEAR + ALTITUD (abajo derecha) ── */
    .gear-cell{
      grid-column:2;grid-row:2;
      display:flex;flex-direction:row;
      align-items:center;justify-content:space-evenly;
      padding:6px 6px 6px 4px;
    }
    .gear-badge{
      width:clamp(68px,17vw,90px);height:clamp(68px,17vw,90px);
      border-radius:50%;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      border:2px solid var(--v);
      background:rgba(124,58,237,0.12);
      box-shadow:0 0 24px rgba(124,58,237,0.5),inset 0 0 24px rgba(124,58,237,0.05);
      transition:all 0.3s;flex-shrink:0;
    }
    .gear-badge.flash{animation:gFlash 0.4s ease-out forwards;}
    @keyframes gFlash{0%{box-shadow:0 0 60px rgba(192,132,252,1),inset 0 0 40px rgba(192,132,252,0.4);border-color:var(--vl);}100%{box-shadow:0 0 24px rgba(124,58,237,0.5);border-color:var(--v);}}
    .gear-badge.warn{border-color:var(--fl);animation:wPulse 0.5s ease-in-out infinite;}
    @keyframes wPulse{0%,100%{box-shadow:0 0 20px rgba(251,146,60,0.5);}50%{box-shadow:0 0 45px rgba(251,146,60,1),0 0 70px rgba(251,146,60,0.35);}}
    .gear-num{font-family:'Orbitron',sans-serif;font-size:clamp(28px,7vw,9dvh);font-weight:900;line-height:1;color:var(--vl);text-shadow:0 0 18px rgba(192,132,252,0.9);}
    .gear-lbl{font-size:clamp(7px,1.8vw,9px);letter-spacing:2px;color:rgba(255,255,255,0.25);margin-top:1px;}
    .gear-info{display:flex;flex-direction:column;align-items:center;gap:5px;}
    .gear-name{font-family:'Orbitron',sans-serif;font-size:clamp(13px,3.5vw,5dvh);font-weight:700;letter-spacing:2px;color:rgba(192,132,252,0.8);}
    .alt-val{font-family:'Orbitron',sans-serif;font-size:clamp(14px,3.8vw,5.5dvh);font-weight:700;color:var(--g);text-shadow:0 0 12px rgba(74,222,128,0.7);letter-spacing:1px;animation:gGlow 3s ease-in-out infinite;}
    @keyframes gGlow{0%,100%{filter:brightness(1);}50%{filter:brightness(1.6);}}
    .alt-label{font-size:clamp(7px,1.8vw,8px);letter-spacing:3px;color:rgba(255,255,255,0.2);}

    /* ── SHIFT ALERT ── */
    .shift-alert{display:none;margin:0;padding:4px 14px;flex-shrink:0;
      background:rgba(251,146,60,0.12);border-left:4px solid var(--fl);
      border-top:1px solid rgba(251,146,60,0.4);border-bottom:1px solid rgba(251,146,60,0.4);
      font-size:clamp(10px,3vw,12px);letter-spacing:4px;color:var(--fl);text-align:center;
      animation:aPulse 0.7s ease-in-out infinite;}
    .shift-alert.on{display:block;}

    /* ══════════════════════════════════════
       LED SPEED LEVEL
    ══════════════════════════════════════ */
    .led-section{
      flex-shrink:0;
      padding:5px 14px 4px;
      border-top:1px solid rgba(255,255,255,0.04);
    }
    .led-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
    .led-lbl{font-size:clamp(7px,2vw,9px);letter-spacing:3px;color:rgba(255,255,255,0.25);}
    .led-status{font-family:'Orbitron',sans-serif;font-size:clamp(9px,2.5vw,11px);font-weight:700;transition:color 0.3s;}
    .led-grid{display:flex;gap:3px;}
    .led-col{display:flex;flex-direction:column-reverse;gap:2px;flex:1;}
    .lseg{height:clamp(6px,1.5dvh,9px);border-radius:2px;
      background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);
      transition:background 0.1s,box-shadow 0.1s,border-color 0.1s;}
    .lseg.green{ background:var(--g); box-shadow:0 0 5px rgba(74,222,128,0.8); border-color:var(--g);}
    .lseg.orange{background:var(--fl);box-shadow:0 0 5px rgba(251,146,60,0.8);border-color:var(--fl);}
    .lseg.red{   background:#ef4444;  box-shadow:0 0 7px rgba(239,68,68,1);   border-color:#ef4444;
      animation:redSeg 0.5s ease-in-out infinite;}
    @keyframes redSeg{0%,100%{box-shadow:0 0 7px rgba(239,68,68,1);}50%{box-shadow:0 0 16px rgba(239,68,68,1),0 0 28px rgba(239,68,68,0.5);}}

    /* ══════════════════════════════════════
       ELEVATION PROFILE
    ══════════════════════════════════════ */
    .elev-section{
      flex-shrink:0;position:relative;
      overflow:hidden;
      border-top:1px solid rgba(255,255,255,0.04);
      border-bottom:1px solid rgba(255,255,255,0.04);
      background:#050010;
    }
    .elev-section canvas{display:block;width:100%;}
    .elev-lbl{position:absolute;font-size:clamp(6px,1.6vw,8px);letter-spacing:2px;
      color:rgba(255,255,255,0.18);pointer-events:none;z-index:3;}
    .elev-lbl.tl{top:4px;left:8px;}
    .elev-lbl.tr{top:4px;right:8px;}
    .elev-lbl.bl{bottom:4px;left:8px;}
    .elev-lbl.br{bottom:4px;right:8px;}
    .slope-badge{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      font-family:'Orbitron',sans-serif;font-size:clamp(7px,2vw,9px);font-weight:700;
      padding:2px 7px;border-radius:3px;z-index:3;pointer-events:none;transition:all 0.4s;
    }
    .slope-badge.flat{color:rgba(255,255,255,0.25);border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.4);}
    .slope-badge.up{  color:var(--fl);border:1px solid rgba(251,146,60,0.4);background:rgba(0,0,0,0.5);text-shadow:0 0 8px rgba(251,146,60,0.7);}
    .slope-badge.down{color:var(--g); border:1px solid rgba(74,222,128,0.4);background:rgba(0,0,0,0.5);text-shadow:0 0 8px rgba(74,222,128,0.7);}
    .center-divider{position:absolute;top:0;bottom:0;left:50%;width:1px;
      background:rgba(255,255,255,0.1);z-index:3;pointer-events:none;}
    .net-indicator{position:absolute;bottom:4px;right:8px;
      font-size:clamp(6px,1.6vw,7px);letter-spacing:1px;z-index:3;transition:color 0.3s;}
    .net-indicator.on{color:rgba(74,222,128,0.5);}
    .net-indicator.off{color:rgba(255,255,255,0.12);}

    /* ── DATA ROW ── */
    .data-row{
      flex:0 0 auto;
      display:grid;grid-template-columns:1fr 1px 1fr 1px 1fr;
      border-top:1px solid rgba(124,58,237,0.25);
      border-bottom:1px solid rgba(234,88,12,0.25);
      background:linear-gradient(90deg,rgba(124,58,237,0.05),rgba(234,88,12,0.05));
    }
    .data-div{background:rgba(255,255,255,0.06);}
    .data-cell{padding:clamp(8px,2dvh,15px) 8px;text-align:center;}
    .data-val{font-family:'Orbitron',sans-serif;font-size:clamp(17px,5vw,3.8dvh);font-weight:700;display:block;letter-spacing:1px;animation:dGlow 3s ease-in-out infinite;}
    .data-val.dist{color:var(--vl);text-shadow:0 0 12px rgba(192,132,252,0.6);font-size:clamp(15px,4.2vw,3.3dvh);}
    .data-val.time{color:#fff;text-shadow:0 0 8px rgba(255,255,255,0.3);animation-delay:.5s;}
    .data-val.mspd{color:var(--fl);text-shadow:0 0 12px rgba(251,146,60,0.6);animation-delay:1s;}
    .data-val.mspd.pop{animation:maxPop 0.5s ease-out;}
    @keyframes maxPop{0%{color:var(--gold);text-shadow:0 0 30px var(--gold),0 0 60px rgba(251,191,36,0.5);transform:scale(1.25);}100%{transform:scale(1);}}
    @keyframes dGlow{0%,100%{filter:brightness(1);}50%{filter:brightness(1.5);}}
    .data-label{font-size:clamp(7px,2vw,9px);letter-spacing:3px;color:rgba(255,255,255,0.2);margin-top:3px;}

    /* ── ODOMETER ROW ── */
    .odo-row{
      flex-shrink:0;
      display:flex;justify-content:space-between;align-items:center;
      padding:5px 14px;
      border-bottom:1px solid rgba(124,58,237,0.2);
      background:rgba(124,58,237,0.06);
    }
    .odo-left{display:flex;align-items:center;gap:10px;}
    .odo-label{font-size:clamp(7px,1.8vw,9px);letter-spacing:3px;color:rgba(255,255,255,0.25);}
    .odo-val{
      font-family:'Orbitron',sans-serif;
      font-size:clamp(16px,4.5vw,5dvh);
      font-weight:900;color:var(--vl);letter-spacing:1px;
      text-shadow:0 0 12px rgba(192,132,252,0.6);
      animation:dGlow 3s ease-in-out infinite;
    }
    .odo-val.pop{animation:odoPop 0.6s ease-out;}
    @keyframes odoPop{0%{color:#fff;text-shadow:0 0 30px rgba(192,132,252,1),0 0 60px rgba(192,132,252,0.5);}100%{color:var(--vl);text-shadow:0 0 12px rgba(192,132,252,0.6);}}
    .odo-unit{font-size:clamp(7px,1.8vw,9px);letter-spacing:3px;color:rgba(255,255,255,0.2);margin-left:2px;}
    .odo-reset-hint{font-size:clamp(6px,1.5vw,7px);letter-spacing:2px;
      color:rgba(255,255,255,0.15);cursor:pointer;padding:4px 8px;
      border:1px solid rgba(255,255,255,0.1);border-radius:3px;transition:all 0.2s;}
    .odo-reset-hint:active{color:rgba(255,255,255,0.5);border-color:rgba(255,255,255,0.3);}

    /* ── PROGRESS BAR ── */
    .prog-wrap{flex-shrink:0;padding:clamp(4px,1dvh,7px) 14px;}
    .prog-meta{display:flex;justify-content:space-between;margin-bottom:4px;}
    .prog-meta span{font-size:clamp(8px,2vw,10px);letter-spacing:1px;color:rgba(255,255,255,0.2);}
    .prog-track{height:clamp(6px,1.5dvh,9px);background:rgba(255,255,255,0.05);border-radius:5px;position:relative;}
    .prog-fill{height:100%;width:0%;border-radius:4px;background:linear-gradient(90deg,#5b21b6,var(--v),var(--f),var(--gold));
      box-shadow:0 0 12px rgba(124,58,237,0.8),0 0 24px rgba(234,88,12,0.35);transition:width 0.7s ease;position:relative;}
    .prog-fill::after{content:'';position:absolute;right:-6px;top:50%;transform:translateY(-50%);
      width:clamp(10px,2.5vw,13px);height:clamp(10px,2.5vw,13px);border-radius:50%;background:#fff;
      box-shadow:0 0 10px var(--vl),0 0 20px var(--f);animation:dPop 1.5s ease-in-out infinite;}
    @keyframes dPop{0%,100%{transform:translateY(-50%) scale(1);}50%{transform:translateY(-50%) scale(1.6);}}

    /* ── BUTTONS ── */
    .controls{flex-shrink:0;display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:6px 14px 5px;}
    .btn{padding:clamp(11px,2.8dvh,18px) 8px;border:none;
      font-family:'Orbitron',sans-serif;font-size:clamp(11px,3vw,14px);font-weight:700;
      letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;
      clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);
      position:relative;overflow:hidden;}
    .btn::after{content:'';position:absolute;top:0;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.13),transparent);animation:bShine 3s linear infinite;}
    @keyframes bShine{0%{left:-100%}100%{left:200%}}
    .btn:active{transform:scale(0.95);}
    .btn-start{background:rgba(124,58,237,0.18);color:var(--vl);border:1px solid rgba(124,58,237,0.6);text-shadow:0 0 10px rgba(192,132,252,0.7);}
    .btn-pause{background:rgba(251,146,60,0.15);color:var(--fl);border:1px solid rgba(234,88,12,0.6);text-shadow:0 0 10px rgba(251,146,60,0.7);}
    .btn-reset{background:rgba(234,88,12,0.1);color:var(--fl);border:1px solid rgba(234,88,12,0.45);}
    .btn-hist{grid-column:1/-1;clip-path:none;background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.3);border:1px solid rgba(255,255,255,0.08);letter-spacing:4px;}
    .btn-hist:active{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.7);}

    /* ── HISTORY ── */
    .history-panel{flex:1;overflow-y:auto;margin:0 14px 6px;border:1px solid rgba(124,58,237,0.2);background:rgba(0,0,0,0.3);display:none;}
    .history-panel.on{display:block;}
    .history-panel::-webkit-scrollbar{width:3px;}
    .history-panel::-webkit-scrollbar-thumb{background:rgba(124,58,237,0.5);border-radius:2px;}
    .history-inner{padding:10px 14px;}
    .history-title{font-size:clamp(9px,2.5vw,11px);letter-spacing:4px;background:linear-gradient(90deg,var(--vl),var(--fl));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
    .history-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(124,58,237,0.3),rgba(234,88,12,0.3));}
    .history-item{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
    .history-item:last-child{border-bottom:none;}
    .hist-km{font-family:'Orbitron',sans-serif;font-size:clamp(14px,4vw,17px);background:linear-gradient(135deg,var(--vl),var(--fl));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .hist-meta{font-size:clamp(8px,2vw,10px);color:rgba(255,255,255,0.2);margin-top:2px;}
    .hist-max{font-family:'Orbitron',sans-serif;font-size:clamp(12px,3.5vw,15px);color:var(--vl);text-align:right;}
    .hist-max-lbl{font-size:clamp(7px,2vw,9px);letter-spacing:2px;color:rgba(255,255,255,0.15);text-align:right;margin-top:2px;}
    .no-history{text-align:center;color:rgba(255,255,255,0.18);font-size:clamp(9px,2.5vw,11px);letter-spacing:3px;padding:20px 0;}
  </style>
</head>
<body>
  <canvas id="particles"></canvas>
  <div class="radar-wrap">
    <div class="radar-ring"></div>
    <div class="rpulse"></div><div class="rpulse"></div><div class="rpulse"></div>
    <div class="rdot"></div><div class="rdot"></div><div class="rdot"></div>
  </div>
  <div class="flames">
    <div class="flame"></div><div class="flame"></div><div class="flame"></div>
    <div class="flame"></div><div class="flame"></div><div class="flame"></div>
    <div class="flame"></div><div class="flame"></div><div class="flame"></div>
  </div>
  <div class="c-tr"></div><div class="c-bl"></div>

  <div class="app">

    <!-- HEADER -->
    <div class="hdr">
      <div class="logo">LEVISPEED</div>
      <div class="hdr-right">
        <div class="status" id="statusEl"><div class="sdot"></div><span id="statusText">INIT GPS</span></div>
        <div class="rec-badge" id="recBadge">● REC</div>
      </div>
    </div>

    <!-- SPEED HERO -->
    <div class="speed-hero">

      <!-- Izquierda: velocidad -->
      <div class="spd-cell" id="spdCell">
        <div class="spd-left">
          <div class="streaks">
            <div class="streak"></div><div class="streak"></div>
            <div class="streak"></div><div class="streak"></div><div class="streak"></div>
          </div>
          <div class="spd-num" id="speedNum" data-v="0">0</div>
          <div class="spd-unit">KM / H</div>
        </div>
        <div class="speed-alert-bar" id="speedAlertBar"></div>
      </div>

      <!-- Arriba derecha: hora -->
      <div class="time-cell">
        <div class="clock-val" id="clockVal">00:00</div>
        <div class="clock-secs" id="clockSecs">:00</div>
        <div class="clock-label">LOCAL TIME</div>
      </div>

      <!-- Abajo derecha: gear + altitud -->
      <div class="gear-cell">
        <div class="gear-badge" id="gearBadge">
          <div class="gear-num" id="gearNum">—</div>
          <div class="gear-lbl">GEAR</div>
        </div>
        <div class="gear-info">
          <div class="gear-name" id="gearName">—</div>
          <div class="alt-val" id="altVal">— m</div>
          <div class="alt-label">ALTITUDE</div>
        </div>
      </div>

    </div>

    <!-- SHIFT ALERT -->
    <div class="shift-alert" id="shiftAlert">⚠ SHIFT DOWN</div>

    <!-- LED SPEED LEVEL -->
    <div class="led-section">
      <div class="led-hdr">
        <span class="led-lbl">SPEED LEVEL</span>

      </div>
      <div class="led-grid" id="ledGrid"></div>
    </div>

    <!-- ELEVATION PROFILE -->
    <div class="elev-section">
      <canvas id="elevCanvas" height="56"></canvas>
      <div class="center-divider" style="left:75%"></div>
      <span class="elev-lbl tl">ELEVATION</span>
      <span class="elev-lbl bl" id="elevMin"></span>
      <span class="elev-lbl br" id="elevMax" style="right:27%"></span>
      <div class="slope-badge flat" id="slopeBadge">── FLAT</div>
      <span class="net-indicator off" id="netIndicator">OFFLINE</span>
    </div>

    <!-- DATA ROW -->
    <div class="data-row">
      <div class="data-cell">
        <span class="data-val dist" id="tripDistance">0.00 km</span>
        <div class="data-label">DISTANCE</div>
      </div>
      <div class="data-div"></div>
      <div class="data-cell">
        <span class="data-val time" id="tripTime">00:00</span>
        <div class="data-label">TIME</div>
      </div>
      <div class="data-div"></div>
      <div class="data-cell">
        <span class="data-val mspd" id="maxSpeed">0</span>
        <div class="data-label">MAX km/h</div>
      </div>
    </div>

    <!-- ODOMETER TOTAL -->
    <div class="odo-row">
      <div class="odo-left">
        <span class="odo-label">TOTAL ODO</span>
        <span class="odo-val" id="odoVal">0.0</span>
        <span class="odo-unit">km</span>
      </div>
      <span class="odo-reset-hint" id="odoResetBtn" onclick="confirmOdoReset()">RESET ODO</span>
    </div>

    <!-- PROGRESS BAR -->
    <div class="prog-wrap">
      <div class="prog-meta">
        <span>0</span><span id="progLabel">0 km/h</span><span>200</span>
      </div>
      <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <button class="btn btn-start" id="startStop">START</button>
      <button class="btn btn-reset" id="resetTrip">RESET</button>
      <button class="btn btn-hist" id="toggleHistory">▼ TRIP HISTORY</button>
    </div>

    <div class="mock-footer" style="text-align:center;font-size:6px;letter-spacing:3px;
      color:rgba(255,255,255,0.08);padding:3px 0;border-top:1px solid rgba(124,58,237,0.08);">
      LEVISPEED v20
    </div>

    <!-- HISTORY -->
    <div class="history-panel" id="historySection">
      <div class="history-inner">
        <div class="history-title">Trip History</div>
        <div id="historyList"><div class="no-history">NO TRIPS RECORDED</div></div>
      </div>
    </div>

  </div>

  <script>
    // ── Particles ──
    const cvs=document.getElementById('particles');
    const pctx=cvs.getContext('2d');
    function resizeCvs(){cvs.width=window.innerWidth;cvs.height=window.innerHeight;}
    resizeCvs();window.addEventListener('resize',resizeCvs);
    const PC=['rgba(168,85,247,','rgba(192,132,252,','rgba(249,115,22,','rgba(251,146,60,','rgba(74,222,128,'];
    const pts=Array.from({length:40},()=>({
      x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,
      r:Math.random()*1.8+0.3,vx:(Math.random()-0.5)*0.3,vy:-Math.random()*0.45-0.1,
      c:PC[Math.floor(Math.random()*PC.length)],a:Math.random()*0.55+0.2,
      life:Math.random(),spd:Math.random()*0.004+0.002
    }));
    function drawPts(){
      pctx.clearRect(0,0,cvs.width,cvs.height);
      pts.forEach(p=>{
        p.life+=p.spd;
        if(p.life>1){p.life=0;p.x=Math.random()*cvs.width;p.y=cvs.height;}
        const a=p.a*Math.sin(p.life*Math.PI);
        pctx.beginPath();pctx.arc(p.x,p.y,p.r,0,Math.PI*2);pctx.fillStyle=p.c+a+')';pctx.fill();
        pctx.beginPath();pctx.arc(p.x,p.y,p.r*3.5,0,Math.PI*2);pctx.fillStyle=p.c+(a*0.1)+')';pctx.fill();
        p.x+=p.vx;p.y+=p.vy;
      });
      requestAnimationFrame(drawPts);
    }
    drawPts();

    // ── Clock ──
    function updateClock(){
      const now=new Date();
      document.getElementById('clockVal').textContent=
        String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
      document.getElementById('clockSecs').textContent=':'+String(now.getSeconds()).padStart(2,'0');
    }
    updateClock();setInterval(updateClock,1000);

    // ── Gear logic ──
    const GEARS=[{num:'1',name:'1ST',max:15},{num:'2',name:'2ND',max:25},{num:'3',name:'3RD',max:35},{num:'4',name:'4TH',max:45},{num:'5',name:'5TH',max:999}];
    function getGearIdx(s){if(s<=0)return null;for(let i=0;i<GEARS.length;i++)if(s<=GEARS[i].max)return i;return GEARS.length-1;}
    function isWarn(s,i){if(i<=0)return false;return s<=(GEARS[i-1].max+3)&&s>GEARS[i-1].max;}

    // ══════════════════════════════════════
    // ODOMETER TOTAL — nunca se resetea con RESET normal
    // Solo con botón dedicado RESET ODO (doble confirmación)
    // ══════════════════════════════════════
    let totalOdo = parseFloat(localStorage.getItem('totalOdo')) || 0;
    let odoConfirmPending = false;
    let odoConfirmTimer = null;

    function updateOdoDisplay(){
      const el=document.getElementById('odoVal');
      const unit=document.querySelector('.odo-unit');
      if(!el) return;
      if(totalOdo>=1000){
        el.textContent=(totalOdo/1000).toFixed(2);
        if(unit) unit.textContent='Mkm';
      } else {
        el.textContent=totalOdo.toFixed(1);
        if(unit) unit.textContent='km';
      }
    }

    function addOdoKm(km){
      if(km <= 0) return;
      totalOdo += km;
      try{ localStorage.setItem('totalOdo', totalOdo.toFixed(3)); }catch(e){}
      updateOdoDisplay();
      // Pop animation
      const el = document.getElementById('odoVal');
      if(el){ el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop'); }
    }

    function confirmOdoReset(){
      const btn = document.getElementById('odoResetBtn');
      if(!odoConfirmPending){
        // Primera pulsación — pide confirmación
        odoConfirmPending = true;
        btn.textContent = 'CONFIRM?';
        btn.style.color = '#ef4444';
        btn.style.borderColor = 'rgba(239,68,68,0.4)';
        // Auto-cancela en 3 segundos
        odoConfirmTimer = setTimeout(()=>{
          odoConfirmPending = false;
          btn.textContent = 'RESET ODO';
          btn.style.color = '';
          btn.style.borderColor = '';
        }, 3000);
      } else {
        // Segunda pulsación — ejecuta reset
        clearTimeout(odoConfirmTimer);
        odoConfirmPending = false;
        totalOdo = 0;
        try{ localStorage.setItem('totalOdo','0'); }catch(e){}
        updateOdoDisplay();
        btn.textContent = 'RESET ODO';
        btn.style.color = '';
        btn.style.borderColor = '';
      }
    }

    updateOdoDisplay();

    // ══════════════════════════════════════
    // LED SPEED LEVEL
    // ══════════════════════════════════════
    const LED_COLS=14, LED_SEGS=6;
    const ledNoise=Array.from({length:LED_COLS},()=>0.78+Math.random()*0.44);

    function buildLedGrid(){
      const g=document.getElementById('ledGrid');
      for(let c=0;c<LED_COLS;c++){
        const col=document.createElement('div');col.className='led-col';
        for(let s=0;s<LED_SEGS;s++){
          const seg=document.createElement('div');
          seg.className='lseg';seg.id=`ls_${c}_${s}`;
          col.appendChild(seg);
        }
        g.appendChild(col);
      }
    }
    buildLedGrid();

    function updateLed(spd){
      const t=Date.now()/1000;
      for(let c=0;c<LED_COLS;c++){
        // Llenado directo: 0→80 km/h = 0→6 segs. Sin multiplicar por noise para no cortarlo.
        const base=(spd/80)*LED_SEGS;
        // Pequeña onda orgánica solo como efecto visual ±0.4 seg
        const wave=Math.sin(t*2+c*0.55)*0.4*(spd/80);
        const filled=Math.min(LED_SEGS,Math.max(0,Math.round(base+wave)));
        for(let s=0;s<LED_SEGS;s++){
          const el=document.getElementById(`ls_${c}_${s}`);
          // column-reverse: s=0 es fondo, s=5 es tope
          // Verde s=0,1 · Naranja s=2,3 · Rojo s=4,5
          el.className='lseg'+(s<filled
            ?(s<=1?' green':s<=3?' orange':' red')
            :'');
        }
      }
    }

    // ══════════════════════════════════════
    // ELEVATION PROFILE — referencia inicio viaje
    // ══════════════════════════════════════
    const elevCvs=document.getElementById('elevCanvas');
    const elevCtx=elevCvs.getContext('2d');
    const MAX_PAST=80;
    let pastAlt=[];
    let tripStartAlt=null; // referencia = primer punto del viaje
    let elevAddCounter=0;

    function resizeElev(){elevCvs.width=elevCvs.offsetWidth||window.innerWidth;}
    resizeElev();window.addEventListener('resize',resizeElev);

    function addElevPoint(alt){
      // Primer punto = referencia del viaje
      if(tripStartAlt===null) tripStartAlt=alt;
      // Suavizado EMA para reducir el ruido del GPS (±15-30m)
      if(pastAlt.length>0){
        const prev=pastAlt[pastAlt.length-1];
        alt=prev*0.7+alt*0.3; // EMA: 70% pasado, 30% nuevo
      }
      elevAddCounter++;
      // Añadir un punto cada 2 llamadas para no saturar
      if(elevAddCounter%2===0){
        pastAlt.push(alt);
        if(pastAlt.length>MAX_PAST) pastAlt.shift();
      }
    }

    function resetElevation(){
      pastAlt=[];
      tripStartAlt=null;
      elevAddCounter=0;
    }

    function drawElevation(){
      const W=elevCvs.width, H=elevCvs.height;
      if(!W||!H) return;

      elevCtx.clearRect(0,0,W,H);

      // Posición del punto "ahora" al 75% del ancho
      const dotX=W*0.75;
      const rightW=W*0.25;

      // Si no hay datos aún, dibujar estado vacío
      if(pastAlt.length<2){
        elevCtx.fillStyle='rgba(255,255,255,0.04)';
        elevCtx.font='8px Share Tech Mono';
        elevCtx.fillText('WAITING GPS...',10,H/2+3);
        return;
      }

      const curAlt=pastAlt[pastAlt.length-1];
      const ref=tripStartAlt||curAlt;

      // Escala relativa al inicio: centrada en el punto de partida
      const diffs=pastAlt.map(a=>a-ref);
      const minD=Math.min(...diffs)-15;
      const maxD=Math.max(...diffs)+15;
      const absMax=Math.max(Math.abs(minD),Math.abs(maxD),30);
      const minA=ref-absMax, maxA=ref+absMax;
      const range=maxA-minA||1;
      const yOf=a=>H-5-((a-minA)/range)*(H-12);

      // ── Línea de referencia (inicio del viaje) ──
      const refY=yOf(ref);
      elevCtx.beginPath();elevCtx.moveTo(0,refY);elevCtx.lineTo(dotX-2,refY);
      elevCtx.strokeStyle='rgba(251,146,60,0.18)';elevCtx.lineWidth=1;
      elevCtx.setLineDash([3,5]);elevCtx.stroke();elevCtx.setLineDash([]);

      // ── Área rellena historial (izquierda hasta 75%) ──
      elevCtx.beginPath();
      elevCtx.moveTo(0,H);
      pastAlt.forEach((a,i)=>{
        elevCtx.lineTo((i/(pastAlt.length-1))*dotX, yOf(a));
      });
      elevCtx.lineTo(dotX,H);elevCtx.closePath();
      const gL=elevCtx.createLinearGradient(0,0,0,H);
      gL.addColorStop(0,'rgba(124,58,237,0.28)');
      gL.addColorStop(1,'rgba(124,58,237,0)');
      elevCtx.fillStyle=gL;elevCtx.fill();

      // ── Línea del perfil ──
      elevCtx.beginPath();
      pastAlt.forEach((a,i)=>{
        const x=(i/(pastAlt.length-1))*dotX;
        i===0?elevCtx.moveTo(x,yOf(a)):elevCtx.lineTo(x,yOf(a));
      });
      elevCtx.strokeStyle='rgba(192,132,252,0.85)';
      elevCtx.lineWidth=1.8;elevCtx.shadowBlur=5;
      elevCtx.shadowColor='rgba(192,132,252,0.4)';
      elevCtx.stroke();elevCtx.shadowBlur=0;

      // ── Zona derecha oscura con datos de altitud ──
      // (el CSS del alt-panel lo cubre, pero dibujamos el fondo)
      elevCtx.fillStyle='rgba(0,0,0,0.45)';
      elevCtx.fillRect(dotX+1,0,rightW,H);

      // ── Punteada gris desde punto hacia la derecha ──
      const posY=yOf(curAlt);
      for(let x=dotX+6;x<W-10;x+=8){
        const prog=(x-dotX)/rightW;
        const alpha=0.2*(1-prog*0.85);
        elevCtx.beginPath();elevCtx.moveTo(x,posY);elevCtx.lineTo(x+4,posY);
        elevCtx.strokeStyle=`rgba(255,255,255,${alpha})`;
        elevCtx.lineWidth=1;elevCtx.stroke();
      }

      // ── Cuadrícula suave (solo zona izquierda) ──
      elevCtx.setLineDash([2,6]);elevCtx.strokeStyle='rgba(255,255,255,0.03)';elevCtx.lineWidth=1;
      [H*0.33,H*0.66].forEach(y=>{
        elevCtx.beginPath();elevCtx.moveTo(0,y);elevCtx.lineTo(dotX,y);elevCtx.stroke();
      });
      elevCtx.setLineDash([]);

      // ── Punto posición actual al 75% ──
      const pulse=0.5+0.5*Math.sin(Date.now()/280);
      elevCtx.beginPath();elevCtx.arc(dotX,posY,9,0,Math.PI*2);
      elevCtx.fillStyle=`rgba(255,255,255,${0.03+pulse*0.05})`;elevCtx.fill();
      elevCtx.beginPath();elevCtx.arc(dotX,posY,5.5,0,Math.PI*2);
      elevCtx.fillStyle=`rgba(251,146,60,${0.3+pulse*0.4})`;
      elevCtx.shadowBlur=8;elevCtx.shadowColor='rgba(251,146,60,0.6)';
      elevCtx.fill();elevCtx.shadowBlur=0;
      elevCtx.beginPath();elevCtx.arc(dotX,posY,2.5,0,Math.PI*2);
      elevCtx.fillStyle='#fff';elevCtx.shadowBlur=10;
      elevCtx.shadowColor='rgba(255,255,255,1)';elevCtx.fill();elevCtx.shadowBlur=0;
      // Línea punteada al suelo
      elevCtx.beginPath();elevCtx.moveTo(dotX,posY+4);elevCtx.lineTo(dotX,H-2);
      elevCtx.strokeStyle='rgba(255,255,255,0.1)';elevCtx.lineWidth=1;
      elevCtx.setLineDash([2,3]);elevCtx.stroke();elevCtx.setLineDash([]);

      // ── Panel derecho: datos de altitud ──
      const diffFromStart=Math.round(curAlt-(tripStartAlt||curAlt));
      const absAlt=Math.round(curAlt);
      // Altitud absoluta
      elevCtx.font='bold 13px Orbitron,monospace';
      elevCtx.textAlign='center';
      const panelCX=dotX+rightW/2;
      elevCtx.fillStyle=diffFromStart>5?'rgba(251,146,60,0.9)':diffFromStart<-5?'rgba(74,222,128,0.9)':'rgba(255,255,255,0.7)';
      elevCtx.fillText(absAlt,panelCX,H*0.38);
      elevCtx.font='7px Share Tech Mono';
      elevCtx.fillStyle='rgba(255,255,255,0.2)';
      elevCtx.fillText('msnm',panelCX,H*0.38+12);
      // Diferencia desde inicio
      const diffStr=(diffFromStart>=0?'+':'')+diffFromStart+'m';
      elevCtx.font='bold 10px Orbitron,monospace';
      elevCtx.fillStyle=diffFromStart>5?'rgba(251,146,60,0.8)':diffFromStart<-5?'rgba(74,222,128,0.8)':'rgba(255,255,255,0.25)';
      elevCtx.fillText(diffStr,panelCX,H*0.72);
      elevCtx.font='6px Share Tech Mono';
      elevCtx.fillStyle='rgba(255,255,255,0.15)';
      elevCtx.fillText('vs inicio',panelCX,H*0.72+10);
      elevCtx.textAlign='left';

      // ── Min/Max labels ──
      const allDiffs=pastAlt.map(a=>a-ref);
      document.getElementById('elevMin').textContent='▼ '+(Math.round(Math.min(...allDiffs)))+'m';
      document.getElementById('elevMax').textContent='▲ +'+(Math.round(Math.max(...allDiffs)))+'m';

      // ── Pendiente ──
      if(pastAlt.length>=10){
        const ar=pastAlt.slice(-5).reduce((a,b)=>a+b,0)/5;
        const ao=pastAlt.slice(-10,-5).reduce((a,b)=>a+b,0)/5;
        const diff=ar-ao;
        const badge=document.getElementById('slopeBadge');
        if(diff>1.5){badge.textContent='▲ UPHILL';badge.className='slope-badge up';}
        else if(diff<-1.5){badge.textContent='▼ DOWNHILL';badge.className='slope-badge down';}
        else{badge.textContent='── FLAT';badge.className='slope-badge flat';}
      }
    }

    // Verificar conectividad
    function checkOnline(){
      const ni=document.getElementById('netIndicator');
      ni.textContent=navigator.onLine?'ONLINE':'OFFLINE';
      ni.className='net-indicator '+(navigator.onLine?'on':'off');
    }
    checkOnline();
    window.addEventListener('online',checkOnline);
    window.addEventListener('offline',checkOnline);
    setInterval(checkOnline,15000);

    // Loop elevación 30fps
    setInterval(()=>{ drawElevation(); }, 33);

    // ══════════════════════════════════════
    // VOICE SYSTEM — Web Speech API
    // Audio ducking + English only
    // ══════════════════════════════════════
    const Voice = {
      synth: window.speechSynthesis,
      speaking: false,
      queue: [],

      // Audio silencioso de 0.1s — fuerza el canal multimedia de Android
      // Mismo truco que usa Waze/Maps para tener prioridad de volumen
      _silentAudio: (()=>{
        // WAV PCM 8bit 8kHz 0.1s — silencio puro
        const wav='UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
        const a=new Audio('data:audio/wav;base64,'+wav);
        a.volume=0.001;
        return a;
      })(),

      getTimeStr(){
        const now = new Date();
        let h = now.getHours();
        const m = now.getMinutes();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        const ms = m === 0 ? "o'clock" : (m < 10 ? 'oh ' + m : String(m));
        return `${h} ${ms} ${ampm}`;
      },

      speak(text, priority=false){
        if(!this.synth) return;
        if(priority){ this.synth.cancel(); this.queue=[]; }
        if(this.queue.length >= 2) return;
        this.queue.push(text);
        if(!this.speaking) this._next();
      },

      _next(){
        if(!this.queue.length){ this.speaking=false; return; }
        this.speaking=true;
        const text=this.queue.shift();
        const utt=new SpeechSynthesisUtterance(text);
        utt.lang   ='en-US';
        utt.rate   =0.92;
        utt.pitch  =1.0;
        utt.volume =1.0;
        utt.onend  =()=>{ setTimeout(()=>this._next(),300); };
        utt.onerror=()=>{ this.speaking=false; this._next(); };
        // Reclamar canal multimedia ANTES de hablar
        // Esto iguala la prioridad de volumen con Maps/Waze en Android
        try{
          this._silentAudio.currentTime=0;
          this._silentAudio.play().then(()=>{
            this.synth.speak(utt);
          }).catch(()=>{
            // Si falla el audio silencioso, hablar de todas formas
            this.synth.speak(utt);
          });
        }catch(e){
          this.synth.speak(utt);
        }
      }
    };

    // ── Main App ──
    class MotoSpeedometer{
      constructor(){
        this.watchId=null;this.lastPosition=null;
        this.currentSpeed=0;this.prevGearIdx=null;
        this.prevSpeed=0;this.prevSpeedTime=null;
        this.accel=0;this.accelSmooth=0; // smoothed accel

        // Voice alert tracking
        this.lastSpeedZone  = 0;   // último umbral cruzado (40/50/60/80/100)
        this.lastAlertSpeed = 0;   // velocidad en el último aviso
        this.last50km       = 0;   // último múltiplo de 50km anunciado
        this.voiceReady     = false;

        this.tripDistance      =parseFloat(localStorage.getItem('tripDistance'))      ||0;
        this.maxSpeed          =parseFloat(localStorage.getItem('maxSpeed'))          ||0;
        this.currentTripDuration=parseInt(localStorage.getItem('currentTripDuration'))||0;
        this.isRecording       =localStorage.getItem('isRecording')==='true';
        this.tripStartTime     =Date.now()-this.currentTripDuration;
        this.pausedTime        =this.currentTripDuration;
        this.history           =this.loadHistory();
        this.isTracking        =false;
        this.init();
      }

      init(){
        this.setupListeners();
        this.startGPS();
        this.startTimer();
        this.updateDisplay();
        // Init voice on first user interaction (required by browsers)
        document.addEventListener('click', ()=>{
          if(!this.voiceReady){
            this.voiceReady=true;
            // Warm up the speech engine silently
            const u=new SpeechSynthesisUtterance('');
            u.volume=0;window.speechSynthesis.speak(u);
          }
        }, {once:true});
        const btn=document.getElementById('startStop');
        if(this.isRecording){
          btn.textContent='PAUSE';btn.className='btn btn-pause';
          document.getElementById('recBadge').classList.add('on');
        } else if(this.currentTripDuration>0){
          btn.textContent='RESUME';btn.className='btn btn-start';
        }
        setInterval(()=>this.saveState(),30000);
      }

      setupListeners(){
        document.getElementById('startStop').addEventListener('click',()=>this.toggleRecording());
        document.getElementById('resetTrip').addEventListener('click',()=>this.resetTrip());
        document.getElementById('toggleHistory').addEventListener('click',()=>this.toggleHistory());
        if('wakeLock' in navigator){
          let wl=null;
          const req=async()=>{try{wl=await navigator.wakeLock.request('screen');}catch(e){}};
          const rel=()=>{if(wl){wl.release();wl=null;}};
          window.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible'&&this.isRecording)req();else rel();});
          if(this.isRecording)req();
        }
      }

      startGPS(){
        if(!navigator.geolocation){this.updateStatus('GPS NOT AVAILABLE',true);return;}
        this.watchId=navigator.geolocation.watchPosition(
          p=>this.onPosition(p),e=>this.onGPSError(e),
          {enableHighAccuracy:true,timeout:10000,maximumAge:1000}
        );
        this.isTracking=true;
        this.updateStatus(this.isRecording?'RECORDING':'STANDBY');
      }

      onPosition(pos){
        this.isTracking=true;
        const spd=(pos.coords.speed!=null&&pos.coords.speed>=0)?pos.coords.speed*3.6:0;
        const now=Date.now();

        // Aceleración suavizada (EMA) para evitar pendulación
        if(this.prevSpeedTime!==null){
          const dt=(now-this.prevSpeedTime)/1000;
          if(dt>0.2&&dt<4){
            const rawAccel=(spd-this.prevSpeed)/dt;
            // EMA alpha=0.3: suaviza sin perder respuesta
            this.accelSmooth=0.3*rawAccel + 0.7*this.accelSmooth;
          }
        }
        // Si está quieto, aceleración a 0 gradualmente
        if(spd<0.5) this.accelSmooth=this.accelSmooth*0.7;

        this.prevSpeed=spd;this.prevSpeedTime=now;
        this.currentSpeed=spd;

        // Max speed
        if(spd>this.maxSpeed){
          this.maxSpeed=spd;
          const el=document.getElementById('maxSpeed');
          el.classList.remove('pop');void el.offsetWidth;el.classList.add('pop');
        }

        // Altitude
        if(pos.coords.altitude!=null){
          const alt=Math.round(pos.coords.altitude);
          document.getElementById('altVal').textContent=alt+' m';
          addElevPoint(alt);
        }

        // Distance
        if(this.isRecording&&this.lastPosition){
          const d=this.calcDist(
            this.lastPosition.coords.latitude,this.lastPosition.coords.longitude,
            pos.coords.latitude,pos.coords.longitude
          );
          if(spd>0.5){
            this.tripDistance+=d;
            addOdoKm(d); // acumula en odómetro total
          }
        }
        this.lastPosition=pos;
        // ── Voice speed alerts ──
        if(this.isRecording && this.voiceReady) this.checkVoiceAlerts(spd);
        this.updateDisplay();
      }

      checkVoiceAlerts(spd){
        const t = Voice.getTimeStr();
        const prev = this.lastAlertSpeed;
        const cur  = Math.round(spd);

        // Umbrales con hora (subiendo O bajando)
        const zones = [40, 50, 60];
        for(const z of zones){
          const crossed = (prev < z && cur >= z) || (prev >= z && cur < z && cur > 0);
          if(crossed && this.lastSpeedZone !== z + (cur>=z?0.1:-0.1)){
            this.lastSpeedZone = z + (cur>=z?0.1:-0.1);
            Voice.speak(`${z} kilometers per hour. Time is ${t}`);
            this.lastAlertSpeed = cur;
            return; // solo un aviso a la vez
          }
        }

        // Alertas de seguridad solo subiendo (sin hora)
        if(prev < 80 && cur >= 80){
          Voice.speak('Warning. 80 kilometers per hour. Please reduce speed.', true);
          this.lastAlertSpeed = cur; return;
        }
        if(prev < 100 && cur >= 100){
          Voice.speak('Danger. Over 100 kilometers per hour. Slow down now.', true);
          this.lastAlertSpeed = cur; return;
        }

        // Cada 50 km
        const km50 = Math.floor(this.tripDistance / 50) * 50;
        if(km50 > 0 && km50 !== this.last50km && this.tripDistance >= km50){
          this.last50km = km50;
          Voice.speak(`${km50} kilometers completed. Consider taking a short break.`);
        }

        this.lastAlertSpeed = cur;
      }

      onGPSError(e){
        const m={1:'GPS DENIED',2:'NO SIGNAL',3:'GPS TIMEOUT'};
        this.updateStatus(m[e.code]||'GPS ERROR',true);
      }

      calcDist(la1,lo1,la2,lo2){
        const R=6371,dLa=this.rad(la2-la1),dLo=this.rad(lo2-lo1);
        const a=Math.sin(dLa/2)**2+Math.cos(this.rad(la1))*Math.cos(this.rad(la2))*Math.sin(dLo/2)**2;
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      }
      rad(d){return d*Math.PI/180;}

      updateDisplay(){
        const spd=Math.round(this.currentSpeed);

        // Speed + alertas
        const nEl=document.getElementById('speedNum');
        const cell=document.getElementById('spdCell');
        const alertBar=document.getElementById('speedAlertBar');
        nEl.textContent=spd;nEl.setAttribute('data-v',spd);
        nEl.classList.remove('warn60','warn80','fast');
        cell.classList.remove('bg80');
        alertBar.classList.remove('warn60','warn80');
        alertBar.textContent='';
        if(spd>=80){
          nEl.classList.add('warn80');cell.classList.add('bg80');
          alertBar.classList.add('warn80');alertBar.textContent='⚠ SPEED LIMIT EXCEEDED';
        }else if(spd>=60){
          nEl.classList.add('warn60');
          alertBar.classList.add('warn60');alertBar.textContent='⚠ SPEED LIMIT';
        }
        if(spd>=100)nEl.classList.add('fast');

        // Data
        document.getElementById('tripDistance').textContent=this.tripDistance.toFixed(2)+' km';
        document.getElementById('maxSpeed').textContent=Math.round(this.maxSpeed);

        // Progress
        document.getElementById('progFill').style.width=Math.min((this.currentSpeed/200)*100,100)+'%';
        document.getElementById('progLabel').textContent=spd+' km/h';

        // LED speed level
        updateLed(spd);

        // Gear
        const gIdx=getGearIdx(this.currentSpeed);
        const badge=document.getElementById('gearBadge');
        const shAlert=document.getElementById('shiftAlert');
        if(gIdx===null){
          document.getElementById('gearNum').textContent='—';
          document.getElementById('gearName').textContent='—';
          badge.classList.remove('warn','flash');shAlert.classList.remove('on');
        }else{
          const g=GEARS[gIdx];
          if(gIdx!==this.prevGearIdx){
            badge.classList.remove('flash');void badge.offsetWidth;badge.classList.add('flash');
            this.prevGearIdx=gIdx;
          }
          document.getElementById('gearNum').textContent=g.num;
          document.getElementById('gearName').textContent=g.name;
          const warn=isWarn(this.currentSpeed,gIdx);
          badge.classList.toggle('warn',warn);shAlert.classList.toggle('on',warn);
        }
      }

      startTimer(){
        setInterval(()=>{
          if(this.isRecording)this.currentTripDuration=Date.now()-this.tripStartTime;
          document.getElementById('tripTime').textContent=this.formatTime(this.currentTripDuration);
        },1000);
      }
      formatTime(ms){
        const t=Math.floor(ms/1000),m=Math.floor(t/60),s=t%60;
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }

      toggleRecording(){
        if(!this.isTracking){this.updateStatus('WAITING FOR GPS...',true);return;}
        this.isRecording=!this.isRecording;
        const btn=document.getElementById('startStop');
        const badge=document.getElementById('recBadge');
        if(this.isRecording){
          // START fresco: resetea elevación
          if(btn.textContent==='START') resetElevation();
          this.tripStartTime=Date.now()-this.pausedTime;
          btn.textContent='PAUSE';btn.className='btn btn-pause';
          badge.classList.add('on');this.updateStatus('RECORDING');
          this.voiceReady=true;
          Voice.speak(`LeviSpeed started. Time is ${Voice.getTimeStr()}`);
        }else{
          this.pausedTime=Date.now()-this.tripStartTime;
          btn.textContent='RESUME';btn.className='btn btn-start';
          badge.classList.remove('on');this.updateStatus('PAUSED');
          Voice.speak(`Ride paused. Time is ${Voice.getTimeStr()}`);
        }
        this.saveState();localStorage.setItem('isRecording',this.isRecording);
      }

      resetTrip(){
        // Resetea todo — km, tiempo, maxSpeed, elevación
        if(this.tripDistance>0||this.currentTripDuration>0){
          this.history.unshift({
            date:new Date().toLocaleDateString('en-US'),
            time:this.formatTime(this.currentTripDuration),
            distance:this.tripDistance,maxSpeed:this.maxSpeed,
            durationMs:this.currentTripDuration
          });
          this.saveHistory();
        }
        this.tripDistance=0;this.maxSpeed=0;this.currentTripDuration=0;this.pausedTime=0;
        this.tripStartTime=Date.now();this.isRecording=false;this.prevGearIdx=null;
        this.accelSmooth=0;this.lastSpeedZone=0;this.lastAlertSpeed=0;this.last50km=0;
        resetElevation();
        this.saveState();localStorage.setItem('isRecording',false);
        this.updateDisplay();
        document.getElementById('startStop').textContent='START';
        document.getElementById('startStop').className='btn btn-start';
        document.getElementById('recBadge').classList.remove('on');
        document.getElementById('tripTime').textContent='00:00';
        document.getElementById('progFill').style.width='0%';
        this.updateHistoryDisplay();
        this.updateStatus(this.isTracking?'STANDBY':'INIT GPS');
      }

      saveState(){
        try{
          localStorage.setItem('tripDistance',this.tripDistance.toFixed(2));
          localStorage.setItem('maxSpeed',this.maxSpeed.toFixed(2));
          localStorage.setItem('currentTripDuration',this.currentTripDuration.toString());
        }catch(e){}
      }
      loadHistory(){try{return JSON.parse(localStorage.getItem('motoTripHistory')||'[]');}catch(e){return[];}}
      saveHistory(){try{localStorage.setItem('motoTripHistory',JSON.stringify(this.history.slice(0,50)));}catch(e){}}

      toggleHistory(){
        const sec=document.getElementById('historySection');
        const btn=document.getElementById('toggleHistory');
        const vis=sec.classList.toggle('on');
        btn.textContent=vis?'▲ HIDE HISTORY':'▼ TRIP HISTORY';
        if(vis)this.updateHistoryDisplay();
      }
      updateHistoryDisplay(){
        const list=document.getElementById('historyList');
        if(!this.history.length){list.innerHTML='<div class="no-history">NO TRIPS RECORDED</div>';return;}
        list.innerHTML=this.history.map(t=>{
          const time=t.durationMs?this.formatTime(t.durationMs):t.time||'N/A';
          return `<div class="history-item">
            <div><div class="hist-km">${t.distance.toFixed(2)} km</div><div class="hist-meta">${t.date} · ${time}</div></div>
            <div><div class="hist-max">${Math.round(t.maxSpeed||0)} km/h</div><div class="hist-max-lbl">MAX</div></div>
          </div>`;
        }).join('');
      }

      updateStatus(msg,isError=false){
        document.getElementById('statusText').textContent=msg;
        document.getElementById('statusEl').className='status'+(isError?' error':(this.isTracking?' active':''));
      }
    }

    // ── Android PWA height fix ──
    // En Android el 100vh/dvh no siempre = pantalla real
    // Medimos el alto visible real y lo forzamos
    function fixHeight(){
      const h = window.innerHeight;
      document.querySelector('.app').style.height = h + 'px';
      document.body.style.height = h + 'px';
    }
    fixHeight();
    window.addEventListener('resize', fixHeight);
    // Re-apply después de que la barra de Android desaparece
    setTimeout(fixHeight, 300);
    setTimeout(fixHeight, 800);

    window.addEventListener('load',()=>{window.speedoInstance=new MotoSpeedometer();fixHeight();});
    window.addEventListener('beforeunload',()=>{
      const i=window.speedoInstance;
      if(i){i.saveState();i.saveHistory();localStorage.setItem('isRecording',i.isRecording);}
    });
    if('serviceWorker' in navigator)
      navigator.serviceWorker.register('service-worker.js')
        .then(r=>console.log('SW:',r.scope)).catch(e=>console.error('SW:',e));
  </script>
</body>
</html>
